name: Workflow Integration Tests

on:
  push:
    branches: [main, develop]
    paths:
      - 'crates/lechange-core/src/http/workflows.rs'
      - 'crates/lechange-core/src/coordination/workflow_tracker.rs'
      - 'crates/lechange-core/tests/workflow_integration.rs'
      - '.github/workflows/workflow-integration-test.yml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'crates/lechange-core/src/http/workflows.rs'
      - 'crates/lechange-core/src/coordination/workflow_tracker.rs'
      - 'crates/lechange-core/tests/workflow_integration.rs'
      - '.github/workflows/workflow-integration-test.yml'
  workflow_dispatch: # Allow manual trigger

env:
  CARGO_TERM_COLOR: always
  RUST_BACKTRACE: 1

jobs:
  workflow-api-tests:
    name: Workflow API Integration Tests
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Full history for git operations

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly
        with:
          components: rustfmt, clippy

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2
        with:
          cache-on-failure: true

      - name: Run workflow API client connection test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_workflow_api_client_connection -- --ignored --nocapture

      - name: Run workflow list with filters test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_list_workflow_runs_with_status_filter -- --ignored --nocapture

      - name: Run commit files retrieval test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_get_commit_files -- --ignored --nocapture

      - name: Run workflow tracker basic test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_workflow_tracker_basic -- --ignored --nocapture

      - name: Run file merging test
        run: |
          cargo test --test workflow_integration test_workflow_tracker_file_merging -- --ignored --nocapture

      - name: Run full pipeline test
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_full_pipeline_with_workflow_tracking -- --ignored --nocapture

      - name: Run rate limit detection test
        run: |
          cargo test --test workflow_integration test_rate_limit_detection -- --ignored --nocapture

      - name: Run environment parsing test
        run: |
          cargo test --test workflow_integration test_workflow_tracker_environment_parsing -- --nocapture

      - name: Summary
        if: always()
        run: |
          echo "## Workflow Integration Test Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "✅ All workflow tracking integration tests completed" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Tests Executed:" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow API client connection" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow listing with status filters" >> $GITHUB_STEP_SUMMARY
          echo "- Commit files retrieval" >> $GITHUB_STEP_SUMMARY
          echo "- Workflow tracker basic functionality" >> $GITHUB_STEP_SUMMARY
          echo "- File merging and deduplication" >> $GITHUB_STEP_SUMMARY
          echo "- Full pipeline integration" >> $GITHUB_STEP_SUMMARY
          echo "- Rate limit detection" >> $GITHUB_STEP_SUMMARY
          echo "- Environment variable parsing" >> $GITHUB_STEP_SUMMARY

  workflow-tracking-e2e:
    name: End-to-End Workflow Tracking Test
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: |
          cargo build --release --package lechange-core

      - name: Create test scenario with multiple commits
        run: |
          git config user.name "Test Bot"
          git config user.email "test@example.com"

          # Create a test branch
          git checkout -b workflow-test-branch-${{ github.run_id }}

          # Make some changes
          echo "test change 1" >> test_file_1.txt
          git add test_file_1.txt
          git commit -m "Test commit 1 for workflow tracking"

          echo "test change 2" >> test_file_2.txt
          git add test_file_2.txt
          git commit -m "Test commit 2 for workflow tracking"

      - name: Test workflow tracking with real API
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_full_pipeline_with_workflow_tracking -- --ignored --nocapture

      - name: Verify workflow data
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### Workflow Tracking Verification" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Repository: ${{ github.repository }}" >> $GITHUB_STEP_SUMMARY
          echo "Branch: ${{ github.ref }}" >> $GITHUB_STEP_SUMMARY
          echo "Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Query current workflows
          WORKFLOW_COUNT=$(gh api repos/${{ github.repository }}/actions/runs --jq '.total_count')
          echo "Total workflows in repository: $WORKFLOW_COUNT" >> $GITHUB_STEP_SUMMARY

          # Query active workflows
          ACTIVE_COUNT=$(gh api repos/${{ github.repository }}/actions/runs?status=in_progress --jq '.total_count')
          echo "Currently active workflows: $ACTIVE_COUNT" >> $GITHUB_STEP_SUMMARY

      - name: Cleanup test branch
        if: always()
        run: |
          git checkout main || git checkout master || true
          git branch -D workflow-test-branch-${{ github.run_id }} || true

  verify-error-handling:
    name: Verify Error Handling
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Test without GITHUB_TOKEN (should handle gracefully)
        run: |
          # Unset token to test error handling
          unset GITHUB_TOKEN

          # This should either succeed with cached data or fail gracefully
          cargo test --test workflow_integration test_rate_limit_detection -- --ignored --nocapture || true

          echo "✅ Error handling test completed" >> $GITHUB_STEP_SUMMARY

      - name: Test with invalid repository format
        run: |
          export GITHUB_REPOSITORY="invalid-format"

          # Should fail with proper error message
          cargo test --test workflow_integration test_workflow_tracker_environment_parsing -- --nocapture

          echo "✅ Invalid input handling test completed" >> $GITHUB_STEP_SUMMARY

      - name: Test timeout configuration
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          cargo test --test workflow_integration test_exponential_backoff_timeout -- --ignored --nocapture

          echo "✅ Timeout configuration test completed" >> $GITHUB_STEP_SUMMARY

  performance-check:
    name: Performance Verification
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Install Rust nightly
        uses: dtolnay/rust-toolchain@nightly

      - name: Cache Rust dependencies
        uses: Swatinem/rust-cache@v2

      - name: Build release binary
        run: |
          cargo build --release --package lechange-core

      - name: Measure API call performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "### Workflow API Performance" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          START_TIME=$(date +%s%3N)
          cargo test --release --test workflow_integration test_workflow_api_client_connection -- --ignored --nocapture
          END_TIME=$(date +%s%3N)

          DURATION=$((END_TIME - START_TIME))
          echo "API connection test: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY

          # Verify it's reasonably fast (under 5 seconds)
          if [ $DURATION -lt 5000 ]; then
            echo "✅ Performance is acceptable" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Performance may be degraded" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Measure full pipeline performance
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          START_TIME=$(date +%s%3N)
          cargo test --release --test workflow_integration test_full_pipeline_with_workflow_tracking -- --ignored --nocapture
          END_TIME=$(date +%s%3N)

          DURATION=$((END_TIME - START_TIME))
          echo "Full pipeline test: ${DURATION}ms" >> $GITHUB_STEP_SUMMARY

          # Verify it's reasonably fast (under 10 seconds)
          if [ $DURATION -lt 10000 ]; then
            echo "✅ Pipeline performance is acceptable" >> $GITHUB_STEP_SUMMARY
          else
            echo "⚠️ Pipeline performance may be degraded" >> $GITHUB_STEP_SUMMARY
          fi

  final-summary:
    name: Test Summary
    runs-on: ubuntu-latest
    needs: [workflow-api-tests, workflow-tracking-e2e, verify-error-handling, performance-check]
    if: always()

    steps:
      - name: Generate summary
        run: |
          echo "# Workflow Integration Test Suite Complete" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "All workflow tracking integration tests have been executed." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Test Jobs:" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Workflow API Tests" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ End-to-End Tracking Test" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Error Handling Verification" >> $GITHUB_STEP_SUMMARY
          echo "- ✅ Performance Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "See individual job outputs for detailed results." >> $GITHUB_STEP_SUMMARY
